"use strict";exports.id=551,exports.ids=[551],exports.modules={65551:(t,e,l)=>{l.r(e),l.d(e,{default:()=>r});var a=l(60687),s=l(43210);function r({imageFile:t,onTranslationComplete:e,onCancel:l}){let r=(0,s.useRef)(null),[n,i]=(0,s.useState)(null),[o,d]=(0,s.useState)(!1),[h,g]=(0,s.useState)(null),[c,u]=(0,s.useState)([]),[f,x]=(0,s.useState)(!1),[p,m]=(0,s.useState)({x:1,y:1}),[w,y]=(0,s.useState)(null),[b,T]=(0,s.useState)(null),v=(0,s.useCallback)(()=>{let t=r.current,e=t?.getContext("2d");t&&e&&n&&(e.clearRect(0,0,t.width,t.height),e.drawImage(n,0,0,t.width,t.height),c.forEach(t=>{if(t.translatedText){let l=t.startX,a=t.startY,s=t.width,r=t.height;if(e.fillStyle="rgba(0, 0, 0, 0.85)",e.fillRect(l,a,s,r),b===t.id?e.strokeStyle="#ff0000":e.strokeStyle="#333333",e.lineWidth=1,e.strokeRect(l,a,s,r),b===t.id){e.strokeStyle="#ff6666",e.lineWidth=2;let t=.1*Math.min(s,r);e.beginPath(),e.moveTo(l+t,a+t),e.lineTo(l+s-t,a+r-t),e.stroke(),e.beginPath(),e.moveTo(l+s-t,a+t),e.lineTo(l+t,a+r-t),e.stroke()}let n=.9*s,i=.9*r,o=t.translatedText.split(" "),d=Math.min(.3*r,40),h=Math.min(.5*r,60),g=8;for(let t=8;t<=h;t+=2){e.font=`bold ${t}px Arial, sans-serif`;let l=[],a="";for(let t of o){let s=a?`${a} ${t}`:t;e.measureText(s).width<=n?a=s:a?(l.push(a),a=t):l.push(t)}a&&l.push(a);let s=1.3*t;if(l.length*s<=i)g=t;else break}d=Math.max(g,8),e.font=`bold ${d}px Arial, sans-serif`,e.fillStyle="white",e.textAlign="center",e.textBaseline="top";let c=[],u="";for(let t of o){let l=u?`${u} ${t}`:t;e.measureText(l).width<=n?u=l:u?(c.push(u),u=t):c.push(t)}u&&c.push(u);let f=1.3*d,x=a+(r-c.length*f)/2;c.forEach((t,a)=>{let r=l+s/2;e.fillText(t,r,x+a*f)})}else t.isTranslating&&(e.fillStyle="rgba(255, 255, 0, 0.3)",e.fillRect(t.startX,t.startY,t.width,t.height),e.strokeStyle="#ffd700",e.lineWidth=2,e.strokeRect(t.startX,t.startY,t.width,t.height),e.fillStyle="white",e.font="bold 16px Arial",e.textAlign="center",e.textBaseline="middle",e.fillText("번역 중...",t.startX+t.width/2,t.startY+t.height/2))}),h&&(e.strokeStyle="#ff0000",e.lineWidth=2,e.setLineDash([5,5]),e.strokeRect(h.startX,h.startY,h.width,h.height),e.setLineDash([])))},[n,c,h,p,b]),j=async()=>{if(!o||!h)return;if(d(!1),20>Math.abs(h.width)||20>Math.abs(h.height))return void g(null);let t={...h,startX:h.width<0?h.startX+h.width:h.startX,startY:h.height<0?h.startY+h.height:h.startY,width:Math.abs(h.width),height:Math.abs(h.height),isTranslating:!0};u(e=>[...e,t]),g(null),await C(t)},C=async t=>{try{let e=document.createElement("canvas"),l=e.getContext("2d");if(!l||!n)return;let a=t.startX*p.x,s=t.startY*p.y,r=t.width*p.x,i=t.height*p.y;e.width=r,e.height=i,l.drawImage(n,a,s,r,i,0,0,r,i);let o=await new Promise(t=>{e.toBlob(e=>t(e),"image/png")}),d=new FormData;d.append("image",o,"selection.png"),d.append("ocrOnly","true");let h=await fetch("/api/upload",{method:"POST",body:d}),g=await h.json();g.success&&g.translatedText?(console.log("\uD83D\uDCDD 번역 완료:",g.translatedText),u(e=>e.map(e=>e.id===t.id?{...e,translatedText:g.translatedText,isTranslating:!1}:e)),console.log("\uD83D\uDCDD selections 업데이트 완료")):(console.log("❌ 번역 실패"),u(e=>e.filter(e=>e.id!==t.id)))}catch(e){console.error("Translation error:",e),u(e=>e.filter(e=>e.id!==t.id))}},S=async()=>{try{if(console.log("\uD83D\uDDBC️ generateTranslatedImage 시작"),console.log("\uD83D\uDDBC️ 처리할 selections:",c.length),!n)return console.log("❌ generateTranslatedImage: 이미지가 없음"),null;let t=document.createElement("canvas"),e=t.getContext("2d");if(!e)return console.log("❌ generateTranslatedImage: 캔버스 컨텍스트를 가져올 수 없음"),null;t.width=n.width,t.height=n.height,e.drawImage(n,0,0),console.log("✅ 원본 이미지를 캔버스에 그렸음:",t.width,"x",t.height),c.filter(t=>t.translatedText).forEach((t,l)=>{console.log(`📝 선택 영역 ${l+1} 처리:`,{id:t.id,translatedText:t.translatedText,position:{x:t.startX,y:t.startY},size:{width:t.width,height:t.height}});let a=t.startX*p.x,s=t.startY*p.y,r=t.width*p.x,n=t.height*p.y;console.log(`📐 실제 좌표 변환:`,{scale:p,real:{x:a,y:s,width:r,height:n}}),e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(a,s,r,n);let i=t.translatedText,o=i.split(" "),d=Math.min(.5*n,60),h=.9*r,g=.9*n,c=8;for(let t=8;t<=d;t+=2){e.font=`bold ${t}px Arial, sans-serif`;let l=[],a="";for(let t of o){let s=a?`${a} ${t}`:t;e.measureText(s).width<=h?a=s:a?(l.push(a),a=t):l.push(t)}a&&l.push(a);let s=1.3*t;if(l.length*s<=g)c=t;else break}let u=Math.max(c,8);e.font=`bold ${u}px Arial, sans-serif`,e.fillStyle="white",e.textAlign="center",e.textBaseline="top",console.log(`🎨 텍스트 렌더링 설정:`,{fontSize:u,text:i,maxTextWidth:h});let f=a+r/2,x=[],m="";for(let t of o){let l=m?`${m} ${t}`:t;e.measureText(l).width<=h?m=l:m?(x.push(m),m=t):x.push(t)}m&&x.push(m);let w=1.3*u,y=x.length*w,b=s+(n-y)/2;x.forEach((t,l)=>{e.fillText(t,f,b+l*w)}),console.log(`✅ 텍스트 렌더링 완료:`,{lines:x.length,totalTextHeight:y})}),console.log("\uD83D\uDDBC️ 캔버스 처리 완료, Blob 생성 중...");let l=await new Promise(e=>{t.toBlob(t=>e(t),"image/jpeg",.85)});console.log("\uD83D\uDCC1 Blob 생성 완료:",l.size,"bytes");let a=new FormData;a.append("image",l,"translated.jpg"),a.append("translateImage","false"),console.log("☁️ Cloudinary 업로드 시작...");let s=await fetch("/api/upload",{method:"POST",body:a}),r=await s.json();if(console.log("☁️ Cloudinary 업로드 응답:",r),r.success)return console.log("✅ generateTranslatedImage 성공:",r.imageUrl),r.imageUrl;return console.log("❌ generateTranslatedImage 실패:",r),null}catch(t){return console.error("❌ generateTranslatedImage 에러:",t),null}},X=async()=>{if(console.log("\uD83D\uDD25 handleComplete 호출됨!"),console.log("\uD83D\uDD25 selections 상태:",{total:c.length,translated:c.filter(t=>t.translatedText).length,translating:c.filter(t=>t.isTranslating).length}),0===c.length)return void console.log("❌ handleComplete: 선택된 영역이 없음");if(c.some(t=>t.isTranslating))return void console.log("❌ handleComplete: 아직 번역 중인 영역이 있음");if(0===c.filter(t=>t.translatedText).length)return void console.log("❌ handleComplete: 번역된 영역이 없음");console.log("✅ handleComplete: 번역된 이미지 생성 시작"),x(!0);try{let t=await S();t?(console.log("✅ handleComplete: 번역된 이미지 URL:",t),e(t)):console.log("❌ handleComplete: 번역된 이미지 생성 실패")}catch(t){console.error("❌ handleComplete 에러:",t)}finally{x(!1)}};return(0,a.jsx)("div",{className:"space-y-4",children:(0,a.jsx)("div",{className:"bg-white border rounded-lg shadow-sm",children:(0,a.jsx)("div",{className:"p-4",children:(0,a.jsxs)("div",{className:"space-y-4 text-center",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold",children:"이미지 번역 편집기"}),(0,a.jsxs)("div",{className:"space-y-1 text-sm text-gray-600",children:[(0,a.jsx)("p",{children:"마우스로 드래그하여 번역할 텍스트 영역을 선택하세요"}),(0,a.jsxs)("p",{className:"text-xs",children:["\uD83D\uDCA1 ",(0,a.jsx)("strong",{children:"팁:"})," 선택된 영역을 ",(0,a.jsx)("span",{className:"text-red-600",children:"클릭"}),"하거나 ",(0,a.jsx)("span",{className:"text-red-600",children:"우클릭"}),"하면 개별 삭제됩니다"]})]}),(0,a.jsx)("div",{className:"flex justify-center",children:(0,a.jsx)("div",{className:"w-full",children:(0,a.jsx)("canvas",{ref:r,onMouseDown:t=>{if(!n)return;let e=r.current;if(!e)return;let l=e.getBoundingClientRect(),a=t.clientX-l.left,s=t.clientY-l.top;for(let t=c.length-1;t>=0;t--){let e=c[t];if(a>=e.startX&&a<=e.startX+e.width&&s>=e.startY&&s<=e.startY+e.height)return void u(t=>t.filter(t=>t.id!==e.id))}d(!0),y({x:a,y:s}),g({id:`selection-${Date.now()}`,startX:a,startY:s,width:0,height:0,isTranslating:!1,translatedText:""})},onMouseMove:t=>{let e=r.current;if(!e)return;let l=e.getBoundingClientRect(),a=t.clientX-l.left,s=t.clientY-l.top,i=null;for(let t=c.length-1;t>=0;t--){let e=c[t];if(a>=e.startX&&a<=e.startX+e.width&&s>=e.startY&&s<=e.startY+e.height){i=e.id;break}}if(T(i),o&&w&&n){let t=a-w.x,e=s-w.y;g(l=>l?{...l,width:Math.abs(t),height:Math.abs(e),startX:t<0?a:w.x,startY:e<0?s:w.y}:null),v()}},onMouseUp:j,onContextMenu:t=>{if(t.preventDefault(),!n)return;let e=r.current;if(!e)return;let l=e.getBoundingClientRect(),a=t.clientX-l.left,s=t.clientY-l.top;for(let t=c.length-1;t>=0;t--){let e=c[t];if(a>=e.startX&&a<=e.startX+e.width&&s>=e.startY&&s<=e.startY+e.height)return void u(t=>t.filter(t=>t.id!==e.id))}},className:"block w-full border border-gray-300 rounded-lg cursor-crosshair"})})}),(0,a.jsxs)("div",{className:"flex justify-center gap-2",children:[(0,a.jsx)("button",{onClick:()=>{u([]),g(null)},disabled:0===c.length,className:"px-4 py-2 text-gray-700 transition-colors border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"선택 초기화"}),(0,a.jsx)("button",{type:"button",onClick:X,disabled:0===c.length||f,className:"px-4 py-2 text-white transition-colors bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:f?"처리 중...":"번역 완료"}),(0,a.jsx)("button",{type:"button",onClick:t=>{t.preventDefault(),t.stopPropagation(),l()},className:"px-4 py-2 text-gray-700 transition-colors border border-gray-300 rounded-lg hover:bg-gray-50",children:"취소"})]}),c.length>0&&(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:["선택된 영역: ",c.length,"개",c.filter(t=>t.translatedText).length>0&&` (번역 완료: ${c.filter(t=>t.translatedText).length}개)`]})]})})})})}}};