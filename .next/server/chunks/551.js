"use strict";exports.id=551,exports.ids=[551],exports.modules={65551:(e,t,l)=>{l.r(t),l.d(t,{default:()=>r});var a=l(60687),s=l(43210);function r({imageFile:e,onTranslationComplete:t,onCancel:l}){let r=(0,s.useRef)(null),[n,i]=(0,s.useState)(null),[o,d]=(0,s.useState)(!1),[h,c]=(0,s.useState)(null),[g,u]=(0,s.useState)([]),[f,x]=(0,s.useState)(!1),[p,m]=(0,s.useState)({x:1,y:1}),[w,b]=(0,s.useState)(null),[y,T]=(0,s.useState)(null),j=(0,s.useCallback)(()=>{let e=r.current,t=e?.getContext("2d");e&&t&&n&&(t.clearRect(0,0,e.width,e.height),t.drawImage(n,0,0,e.width,e.height),g.forEach(e=>{if(e.translatedText){let l=e.startX,a=e.startY,s=e.width,r=e.height;if(t.fillStyle="rgba(0, 0, 0, 0.85)",t.fillRect(l,a,s,r),y===e.id?t.strokeStyle="#ff0000":t.strokeStyle="#333333",t.lineWidth=1,t.strokeRect(l,a,s,r),y===e.id){t.strokeStyle="#ff6666",t.lineWidth=2;let e=.1*Math.min(s,r);t.beginPath(),t.moveTo(l+e,a+e),t.lineTo(l+s-e,a+r-e),t.stroke(),t.beginPath(),t.moveTo(l+s-e,a+e),t.lineTo(l+e,a+r-e),t.stroke()}let n=.9*s,i=.9*r,o=e.translatedText.split(" "),d=Math.min(.3*r,40),h=Math.min(.5*r,60),c=8;for(let e=8;e<=h;e+=2){t.font=`bold ${e}px Arial, sans-serif`;let l=[],a="";for(let e of o){let s=a?`${a} ${e}`:e;t.measureText(s).width<=n?a=s:a?(l.push(a),a=e):l.push(e)}a&&l.push(a);let s=1.3*e;if(l.length*s<=i)c=e;else break}d=Math.max(c,8),t.font=`bold ${d}px Arial, sans-serif`,t.fillStyle="white",t.textAlign="center",t.textBaseline="top";let g=[],u="";for(let e of o){let l=u?`${u} ${e}`:e;t.measureText(l).width<=n?u=l:u?(g.push(u),u=e):g.push(e)}u&&g.push(u);let f=1.3*d,x=a+(r-g.length*f)/2;g.forEach((e,a)=>{let r=l+s/2;t.fillText(e,r,x+a*f)})}else e.isTranslating&&(t.fillStyle="rgba(255, 255, 0, 0.3)",t.fillRect(e.startX,e.startY,e.width,e.height),t.strokeStyle="#ffd700",t.lineWidth=2,t.strokeRect(e.startX,e.startY,e.width,e.height),t.fillStyle="white",t.font="bold 16px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("번역 중...",e.startX+e.width/2,e.startY+e.height/2))}),h&&(t.strokeStyle="#ff0000",t.lineWidth=2,t.setLineDash([5,5]),t.strokeRect(h.startX,h.startY,h.width,h.height),t.setLineDash([])))},[n,g,h,p,y]),v=async()=>{if(!o||!h)return;if(d(!1),20>Math.abs(h.width)||20>Math.abs(h.height))return void c(null);let e={...h,startX:h.width<0?h.startX+h.width:h.startX,startY:h.height<0?h.startY+h.height:h.startY,width:Math.abs(h.width),height:Math.abs(h.height),isTranslating:!0};u(t=>[...t,e]),c(null),await C(e)},C=async e=>{try{let t=document.createElement("canvas"),l=t.getContext("2d");if(!l||!n)return;let a=e.startX*p.x,s=e.startY*p.y,r=e.width*p.x,i=e.height*p.y;t.width=r,t.height=i,l.drawImage(n,a,s,r,i,0,0,r,i);let o=await new Promise(e=>{t.toBlob(t=>e(t),"image/png")}),d=new FormData;d.append("image",o,"selection.png"),d.append("ocrOnly","true");let h=await fetch("/api/upload",{method:"POST",body:d}),c=await h.json();c.success&&c.translatedText?(console.log("\uD83D\uDCDD 번역 완료:",c.translatedText),u(t=>t.map(t=>t.id===e.id?{...t,translatedText:c.translatedText,isTranslating:!1}:t)),console.log("\uD83D\uDCDD selections 업데이트 완료")):(console.log("❌ 번역 실패"),u(t=>t.filter(t=>t.id!==e.id)))}catch(t){console.error("Translation error:",t),u(t=>t.filter(t=>t.id!==e.id))}},S=async()=>{try{if(console.log("\uD83D\uDDBC️ generateTranslatedImage 시작"),console.log("\uD83D\uDDBC️ 처리할 selections:",g.length),!n)return console.log("❌ generateTranslatedImage: 이미지가 없음"),null;let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)return console.log("❌ generateTranslatedImage: 캔버스 컨텍스트를 가져올 수 없음"),null;e.width=n.width,e.height=n.height,t.drawImage(n,0,0),console.log("✅ 원본 이미지를 캔버스에 그렸음:",e.width,"x",e.height),g.filter(e=>e.translatedText).forEach((e,l)=>{console.log(`📝 선택 영역 ${l+1} 처리:`,{id:e.id,translatedText:e.translatedText,position:{x:e.startX,y:e.startY},size:{width:e.width,height:e.height}});let a=e.startX*p.x,s=e.startY*p.y,r=e.width*p.x,n=e.height*p.y;console.log(`📐 실제 좌표 변환:`,{scale:p,real:{x:a,y:s,width:r,height:n}}),t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(a,s,r,n);let i=e.translatedText,o=i.split(" "),d=Math.min(.5*n,60),h=.9*r,c=.9*n,g=8;for(let e=8;e<=d;e+=2){t.font=`bold ${e}px Arial, sans-serif`;let l=[],a="";for(let e of o){let s=a?`${a} ${e}`:e;t.measureText(s).width<=h?a=s:a?(l.push(a),a=e):l.push(e)}a&&l.push(a);let s=1.3*e;if(l.length*s<=c)g=e;else break}let u=Math.max(g,8);t.font=`bold ${u}px Arial, sans-serif`,t.fillStyle="white",t.textAlign="center",t.textBaseline="top",console.log(`🎨 텍스트 렌더링 설정:`,{fontSize:u,text:i,maxTextWidth:h});let f=a+r/2,x=[],m="";for(let e of o){let l=m?`${m} ${e}`:e;t.measureText(l).width<=h?m=l:m?(x.push(m),m=e):x.push(e)}m&&x.push(m);let w=1.3*u,b=x.length*w,y=s+(n-b)/2;x.forEach((e,l)=>{t.fillText(e,f,y+l*w)}),console.log(`✅ 텍스트 렌더링 완료:`,{lines:x.length,totalTextHeight:b})}),console.log("\uD83D\uDDBC️ 캔버스 처리 완료, Blob 생성 중...");let l=await new Promise(t=>{e.toBlob(e=>t(e),"image/jpeg",.85)});console.log("\uD83D\uDCC1 Blob 생성 완료:",l.size,"bytes");let a=new FormData;a.append("image",l,"translated.jpg"),a.append("translateImage","false"),console.log("☁️ Cloudinary 업로드 시작...");let s=await fetch("/api/upload",{method:"POST",body:a}),r=await s.json();if(console.log("☁️ Cloudinary 업로드 응답:",r),r.success)return console.log("✅ generateTranslatedImage 성공:",r.imageUrl),r.imageUrl;return console.log("❌ generateTranslatedImage 실패:",r),null}catch(e){return console.error("❌ generateTranslatedImage 에러:",e),null}},X=async()=>{if(console.log("\uD83D\uDD25 handleComplete 호출됨!"),console.log("\uD83D\uDD25 selections 상태:",{total:g.length,translated:g.filter(e=>e.translatedText).length,translating:g.filter(e=>e.isTranslating).length}),0===g.length)return void console.log("❌ handleComplete: 선택된 영역이 없음");if(g.some(e=>e.isTranslating))return void console.log("❌ handleComplete: 아직 번역 중인 영역이 있음");if(0===g.filter(e=>e.translatedText).length)return void console.log("❌ handleComplete: 번역된 영역이 없음");console.log("✅ handleComplete: 번역된 이미지 생성 시작"),x(!0);try{let e=await S();e?(console.log("✅ handleComplete: 번역된 이미지 URL:",e),t(e)):console.log("❌ handleComplete: 번역된 이미지 생성 실패")}catch(e){console.error("❌ handleComplete 에러:",e)}finally{x(!1)}},Y=async()=>{x(!0);try{let l=new FormData;l.append("image",e),l.append("translateImage","false");let a=await fetch("/api/upload",{method:"POST",body:l}),s=await a.json();if(s.success)console.log("✅ 원본 이미지 업로드 성공:",s.imageUrl),t(s.imageUrl);else throw console.log("❌ 원본 이미지 업로드 실패:",s),Error(s.error||"원본 이미지 업로드에 실패했습니다")}catch(e){console.error("❌ 원본 이미지 업로드 에러:",e),alert("원본 이미지 업로드에 실패했습니다.")}finally{x(!1)}};return(0,a.jsx)("div",{className:"space-y-4",children:(0,a.jsx)("div",{className:"bg-white border rounded-lg shadow-sm",children:(0,a.jsx)("div",{className:"p-4",children:(0,a.jsxs)("div",{className:"space-y-4 text-center",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold",children:"이미지 번역 편집기"}),(0,a.jsxs)("div",{className:"space-y-1 text-sm text-gray-600",children:[(0,a.jsx)("p",{children:"마우스로 드래그하여 번역할 텍스트 영역을 선택하세요"}),(0,a.jsxs)("p",{className:"text-xs",children:["\uD83D\uDCA1 ",(0,a.jsx)("strong",{children:"팁:"})," 선택된 영역을 ",(0,a.jsx)("span",{className:"text-red-600",children:"클릭"}),"하거나 ",(0,a.jsx)("span",{className:"text-red-600",children:"우클릭"}),"하면 개별 삭제됩니다"]}),(0,a.jsxs)("p",{className:"text-xs text-blue-600",children:["번역을 원하지 않는다면 ",(0,a.jsx)("strong",{children:'"원본 업로드"'})," 버튼을 클릭하세요"]})]}),(0,a.jsx)("div",{className:"flex justify-center",children:(0,a.jsx)("div",{className:"w-full",children:(0,a.jsx)("canvas",{ref:r,onMouseDown:e=>{if(!n)return;let t=r.current;if(!t)return;let l=t.getBoundingClientRect(),a=e.clientX-l.left,s=e.clientY-l.top;for(let e=g.length-1;e>=0;e--){let t=g[e];if(a>=t.startX&&a<=t.startX+t.width&&s>=t.startY&&s<=t.startY+t.height)return void u(e=>e.filter(e=>e.id!==t.id))}d(!0),b({x:a,y:s}),c({id:`selection-${Date.now()}`,startX:a,startY:s,width:0,height:0,isTranslating:!1,translatedText:""})},onMouseMove:e=>{let t=r.current;if(!t)return;let l=t.getBoundingClientRect(),a=e.clientX-l.left,s=e.clientY-l.top,i=null;for(let e=g.length-1;e>=0;e--){let t=g[e];if(a>=t.startX&&a<=t.startX+t.width&&s>=t.startY&&s<=t.startY+t.height){i=t.id;break}}if(T(i),o&&w&&n){let e=a-w.x,t=s-w.y;c(l=>l?{...l,width:Math.abs(e),height:Math.abs(t),startX:e<0?a:w.x,startY:t<0?s:w.y}:null),j()}},onMouseUp:v,onContextMenu:e=>{if(e.preventDefault(),!n)return;let t=r.current;if(!t)return;let l=t.getBoundingClientRect(),a=e.clientX-l.left,s=e.clientY-l.top;for(let e=g.length-1;e>=0;e--){let t=g[e];if(a>=t.startX&&a<=t.startX+t.width&&s>=t.startY&&s<=t.startY+t.height)return void u(e=>e.filter(e=>e.id!==t.id))}},className:"block w-full border border-gray-300 rounded-lg cursor-crosshair"})})}),(0,a.jsxs)("div",{className:"flex justify-center gap-2 flex-wrap",children:[(0,a.jsx)("button",{onClick:()=>{u([]),c(null)},disabled:0===g.length,className:"px-4 py-2 text-gray-700 transition-colors border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"선택 초기화"}),(0,a.jsx)("button",{type:"button",onClick:X,disabled:0===g.length||f,className:"px-4 py-2 text-white transition-colors bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:f?"처리 중...":"번역 완료"}),(0,a.jsx)("button",{type:"button",onClick:Y,disabled:f,className:"px-4 py-2 text-white transition-colors bg-green-600 rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed",children:f?"업로드 중...":"원본 업로드"}),(0,a.jsx)("button",{type:"button",onClick:e=>{e.preventDefault(),e.stopPropagation(),l()},className:"px-4 py-2 text-gray-700 transition-colors border border-gray-300 rounded-lg hover:bg-gray-50",children:"취소"})]}),g.length>0&&(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:["선택된 영역: ",g.length,"개",g.filter(e=>e.translatedText).length>0&&` (번역 완료: ${g.filter(e=>e.translatedText).length}개)`]})]})})})})}}};